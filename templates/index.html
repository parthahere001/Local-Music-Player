<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Music Player</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #main {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f5f5f5;
    }

    #controls {
      padding: 20px;
      background: #fff;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      border-top: 1px solid #ddd;
    }

    input, button, select {
      margin-top: 10px;
      padding: 8px;
      width: 100%;
    }

    #playlist li, #queue li {
      cursor: pointer;
      margin: 10px 0;
      list-style: none;
    }

    li img {
      width: 50px;
      height: 50px;
      margin-right: 10px;
      object-fit: cover;
      border-radius: 6px;
    }

    .queue-buttons button, .playlist-buttons button {
      margin-left: 10px;
      padding: 4px 8px;
      font-size: 0.8rem;
    }

    #playlist li, #queue li {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #playlist li > div, #queue li > span {
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="main">
      <h1>ğŸ¶ My Music Player</h1>

      <input type="text" id="search" placeholder="Search title, artist, album..." oninput="handleSearch()" />
      <select id="artist-filter" onchange="handleSearch()">
        <option value="">ğŸ¤ Filter by artist</option>
      </select>

      <h3>All Songs</h3>
      <ul id="playlist"></ul>
    </div>

    <div id="controls">
      <h3>Queue</h3>
      <ul id="queue"></ul>
      <button onclick="playNext()">â–¶ï¸ Play Next</button>

      <h3>Player</h3>
      <audio id="player" controls style="width: 100%; margin-top: 10px;"></audio>

      <h3>ğŸµ Save Playlist</h3>
      <input type="text" id="playlist-name" placeholder="Playlist name..." />
      <button onclick="savePlaylist()">Save</button>

      <h3>ğŸ“‚ Load Playlist</h3>
      <input type="text" id="load-name" placeholder="Playlist name..." />
      <button onclick="loadPlaylist()">Load</button>
    </div>
  </div>

  <script>
    const queue = [];
    const queueElem = document.getElementById("queue");
    const player = document.getElementById("player");
    const artistFilter = document.getElementById("artist-filter");
    let songs = [];

    function formatDuration(seconds) {
      const m = Math.floor(seconds / 60);
      const s = String(Math.floor(seconds % 60)).padStart(2, '0');
      return `${m}:${s}`;
    }

    function loadAllSongs() {
      fetch("/api/songs")
        .then(res => res.json())
        .then(data => {
          songs = data;
          populateArtistFilter(songs);
          showSongs(songs);
        });
    }

    function populateArtistFilter(songs) {
      const artists = Array.from(new Set(songs.map(s => s.artist))).sort();
      artistFilter.innerHTML = `<option value="">ğŸ¤ Filter by artist</option>`;
      artists.forEach(artist => {
        const opt = document.createElement("option");
        opt.value = artist;
        opt.textContent = artist;
        artistFilter.appendChild(opt);
      });
    }

    function showSongs(list) {
      const sorted = [...list].sort((a, b) => a.title.localeCompare(b.title));
      const currentIds = Array.from(document.querySelectorAll("#playlist li")).map(li => li.dataset.id);
      const newIds = sorted.map(s => s.id);
      if (JSON.stringify(currentIds) === JSON.stringify(newIds)) return;

      const playlist = document.getElementById("playlist");
      playlist.innerHTML = "";

      sorted.forEach(song => {
        const li = document.createElement("li");
        li.dataset.id = song.id;

        const left = document.createElement("div");

        const img = document.createElement("img");
        img.src = `/api/cover/${song.id}`;
        img.onerror = () => img.src = "/static/default.jpg";
        left.appendChild(img);

        const text = document.createElement("span");
        text.innerHTML = `<b>${song.title}</b> - ${song.artist} <small>(${formatDuration(song.duration)})</small>`;
        left.appendChild(text);

        const btns = document.createElement("div");
        btns.className = "playlist-buttons";

        const qBtn = document.createElement("button");
        qBtn.textContent = "â• Queue";
        qBtn.onclick = (e) => { e.stopPropagation(); addToQueue(song.id); };

        const pNowBtn = document.createElement("button");
        pNowBtn.textContent = "â–¶ï¸ Play Now";
        pNowBtn.onclick = (e) => { e.stopPropagation(); playNow(song.id); };

        li.appendChild(left);
        btns.appendChild(qBtn);
        btns.appendChild(pNowBtn);
        li.appendChild(btns);

        playlist.appendChild(li);
      });
    }

    function addToQueue(id) {
      queue.push(id);
      updateQueue();
    }

    function playNow(id) {
      queue.unshift(id);
      updateQueue();
      playNext();
    }

    function updateQueue() {
      queueElem.innerHTML = "";
      queue.forEach((id, i) => {
        const song = songs.find(s => s.id === id);
        const li = document.createElement("li");

        const text = document.createElement("span");
        text.textContent = `${i + 1}. ${song.title}`;

        const btn = document.createElement("button");
        btn.textContent = "âŒ";
        btn.onclick = (e) => {
          e.stopPropagation();
          queue.splice(i, 1);
          updateQueue();
        };

        li.onclick = () => playSong(id);
        li.appendChild(text);
        li.appendChild(btn);
        queueElem.appendChild(li);
      });
    }

    function playSong(id) {
      player.src = `/music/${id}`;
      player.play();
    }

    function playNext() {
      if (queue.length === 0) return;
      const next = queue.shift();
      playSong(next);
      updateQueue();
    }

    player.onended = playNext;

    function handleSearch() {
      const q = document.getElementById("search").value.toLowerCase();
      const artist = artistFilter.value;
      const filtered = songs.filter(song =>
        (song.title.toLowerCase().includes(q) ||
         song.artist.toLowerCase().includes(q) ||
         song.album.toLowerCase().includes(q)) &&
        (artist === "" || song.artist === artist)
      );
      showSongs(filtered);
    }

    function savePlaylist() {
      const name = document.getElementById("playlist-name").value;
      if (!name || queue.length === 0) return alert("Provide playlist name and queue at least one song.");
      fetch("/api/save_playlist", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `name=${encodeURIComponent(name)}&songs=${encodeURIComponent(JSON.stringify(queue))}`
      }).then(() => alert("Playlist saved."));
    }

    function loadPlaylist() {
      const name = document.getElementById("load-name").value;
      if (!name) return;
      fetch(`/api/load_playlist/${name}`)
        .then(res => res.json())
        .then(data => {
          queue.length = 0;
          data.forEach(id => queue.push(id));
          updateQueue();
        });
    }

    window.onload = loadAllSongs;
  </script>
</body>
</html>
